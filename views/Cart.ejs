<% include partials/head %>

<script src="https://checkout.stripe.com/checkout.js" ></script>
<script src="/scripts/cart.js"></script>
<script>
  const stripePublicKey = '<%= locals.stripePublicKey %>';
</script>
<!--<script src="scripts/store.js"></script>-->

<div class="container"> 
  <div class="container-cart">
    <div class="cart-row">
      <span class="cart-item cart-header cart-column">ITEM</span>
      <span class="cart-price cart-header cart-column">PRICE</span>
      <span class="cart-quantity cart-header cart-column">QUANTITY</span>
    </div>
    <% if(locals.products){ %>
      <% Object.keys(locals.products).forEach(function (index) { %>
        <div class="cart-row cart-row-item" id="<%= locals.products[index].item._id %>">
          <div class="cart-item cart-column">
            <img class="cart-img" src="/api/gallery/image/<%= locals.products[index].item._id %>" alt="<%= locals.products[index].item.title %>">
            <div class="cart-title-description">
              <h4 class="cart-item-title"><b><%= locals.products[index].item.title %></b></h4>
              <p class="cart-item-description"><%= locals.products[index].item.content %></p>
            </div>
          </div>
              
          <div class="cart-price cart-column ">
            <p class="cart-item-price"><b><%= locals.products[index].price %>€</b></p>
          </div>
              
          <div class="cart-quantity cart-column">
            <i class="fas fa-minus fa-2x qty-update qty-decrease" onclick="cartDel('<%= locals.products[index].item._id %>', this)"></i>
            <h4 class="cart-item-qty"><b><%= locals.products[index].qty %></b></h4>
            <i class="fas fa-plus fa-2x qty-update qty-increase" onclick="cartAdd('<%= locals.products[index].item._id %>', this)"></i>
            <!--<a class="qty-update qty-decrease" href="#delete">-</a> 
            <h4 class="cart-item-qty"><%= locals.products[index].qty %></h4>
            <a class="qty-update qty-increase" href="/api/cart/add-to-cart/<%= locals.products[index].item._id %>">+</a>-->
          </div>
      </div>
      <% }) %>
    <% } %>
    <div class="cart-total">
      <% if(locals.totalPrice){ %>
          TOTAL PRICE: <b id="total-price"><%= locals.totalPrice %>€</b>
      <% } %>
      <% if(locals.totalQty){ %>
          NUMBER OF ITEMS: <b id="total-qty"><%= locals.totalQty %></b><br/>
      <% } %>
      <input type="hidden" id="total-price-input" value="<%= locals.totalPrice %>">
      <button class="btn btn-primary btn-purchase" onclick="submitCheckout();" type="button">PURCHASE</button>
    </div>
  </div>
</div>


<script>
let stripeHandler = StripeCheckout.configure({
  key: stripePublicKey,
  locale: "auto",
  token: function (token) {
    let items = [];
    let rows = $(".cart-row-item")
        
    for (let i = 0; i < rows.length; i++) { 
      let id = rows[i].id;
      let quantity = parseInt($("div.cart-quantity.cart-column > h4 > b")[i].innerText);
      let price = parseFloat($("div.cart-price.cart-column > p > b")[i].innerText);
      items.push({
        id: id,
        price: price,
        quantity: quantity
      });
    }

    fetch('/api/cart/purchase', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        stripeTokenId: token.id,
        items: items
      })
    })
    .then((res) => {return res.json();})
    .then((data) => {
      console.log(data);
      //if purchase successfull else dont clear
      window.location.href = "http://localhost:8089/api/cart/clear";
    })
    .catch((err) => {
      console.log(err);
    })
  }
})

function submitCheckout () {
  let price = parseFloat(document.getElementById("total-price-input").getAttribute("value")) * 100;
  console.log(price)
  stripeHandler.open({
    amount: price
  })
}
</script>

  
<% include partials/footer %>